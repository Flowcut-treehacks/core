<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plan Graph</title>
  <script type="text/javascript" src="qrc:/qtwebchannel/qwebchannel.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 12px;
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 13px;
      background: #0d0d0f;
      color: #e2e2ea;
    }
    .plan-graph {
      padding: 0;
      min-height: 120px;
    }
    .plan-graph ul {
      list-style: none;
      padding: 0 0 0 20px;
      margin: 4px 0 8px 0;
      border-left: 2px solid rgba(139, 92, 246, 0.35);
      position: relative;
    }
    .plan-graph ul::before {
      content: '';
      position: absolute;
      left: -2px;
      top: 0;
      bottom: 0;
      width: 2px;
      border-radius: 1px;
      background: linear-gradient(180deg, rgba(139, 92, 246, 0.5), rgba(139, 92, 246, 0.15));
    }
    .node-wrap {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    .node-wrap > .node { flex-shrink: 0; }
    .node-wrap > ul { flex: 1; min-width: 0; }
    .node {
      margin: 4px 0;
      padding: 10px 12px;
      min-width: 160px;
      max-width: 280px;
      border-radius: 10px;
      cursor: pointer;
      transition: box-shadow 0.2s ease, transform 0.15s ease, background 0.2s;
      border: 1px solid rgba(139, 92, 246, 0.25);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .node:hover {
      box-shadow: 0 0 16px rgba(139, 92, 246, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
      transform: translateY(-1px);
    }
    .node.root {
      background: linear-gradient(135deg, #3b2a5c 0%, #2d1f4a 100%);
      color: #e9e0ff;
      font-weight: 700;
      border-color: rgba(167, 139, 250, 0.4);
      box-shadow: 0 2px 12px rgba(88, 28, 135, 0.4);
    }
    .node.root:hover {
      box-shadow: 0 0 20px rgba(167, 139, 250, 0.35), 0 2px 12px rgba(88, 28, 135, 0.4);
    }
    .node.branch {
      background: linear-gradient(135deg, #2e2345 0%, #1f1830 100%);
      color: #c4b5fd;
      font-weight: 600;
      border-color: rgba(139, 92, 246, 0.3);
    }
    .node.step {
      background: linear-gradient(135deg, #251f35 0%, #1a1625 100%);
      color: #a78bfa;
      border-color: rgba(139, 92, 246, 0.2);
    }
    .node-label {
      font-weight: 600;
      font-size: 13px;
      line-height: 1.3;
      margin-bottom: 6px;
    }
    .node-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .node-pills .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 500;
      background: rgba(139, 92, 246, 0.25);
      color: #c4b5fd;
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    .node-desc {
      font-size: 11px;
      color: #a6adc8;
      margin-top: 4px;
      line-height: 1.35;
    }
    .node-result {
      font-size: 11px;
      color: #8b8b9e;
      margin-top: 4px;
      max-height: 3em;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .empty-state {
      color: #6c7086;
      padding: 16px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="plan-root" class="plan-graph">
    <div class="empty-state">Send a message in the AI chat to see the edit plan graph here.</div>
  </div>
  <script>
    function setPlanGraph(jsonStr) {
      var rootEl = document.getElementById('plan-root');
      if (!jsonStr || jsonStr === 'null') {
        rootEl.innerHTML = '<div class="empty-state">No plan yet. Send a message in the AI chat to see the edit plan graph.</div>';
        return;
      }
      var data;
      try {
        data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
      } catch (e) {
        rootEl.innerHTML = '<div class="empty-state">Invalid plan data.</div>';
        return;
      }
      rootEl.innerHTML = '';
      rootEl.appendChild(renderNode(data));
    }
    function renderNode(n) {
      var wrap = document.createElement('div');
      wrap.className = 'node-wrap';
      var div = document.createElement('div');
      div.className = 'node ' + (n.type || '');
      div.setAttribute('data-node-id', n.id || '');
      var label = document.createElement('div');
      label.className = 'node-label';
      label.textContent = n.label || n.type || 'Node';
      div.appendChild(label);
      if (n.tool_name || n.status || n.timestamp) {
        var pills = document.createElement('div');
        pills.className = 'node-pills';
        if (n.tool_name) {
          var t = document.createElement('span');
          t.className = 'pill';
          t.textContent = n.tool_name;
          pills.appendChild(t);
        }
        if (n.status) {
          var s = document.createElement('span');
          s.className = 'pill';
          s.textContent = n.status;
          pills.appendChild(s);
        }
        if (n.timestamp) {
          var ts = document.createElement('span');
          ts.className = 'pill';
          ts.textContent = n.timestamp;
          pills.appendChild(ts);
        }
        div.appendChild(pills);
      }
      if (n.description) {
        var desc = document.createElement('div');
        desc.className = 'node-desc';
        desc.textContent = n.description.length > 120 ? n.description.slice(0, 120) + '…' : n.description;
        div.appendChild(desc);
      }
      if (n.result) {
        var res = document.createElement('div');
        res.className = 'node-result';
        res.textContent = n.result.length > 150 ? n.result.slice(0, 150) + '…' : n.result;
        div.appendChild(res);
      }
      div.onclick = function() { onNodeClick(n); };
      wrap.appendChild(div);
      if (n.children && n.children.length) {
        var ul = document.createElement('ul');
        n.children.forEach(function(c) {
          var li = document.createElement('li');
          li.appendChild(renderNode(c));
          ul.appendChild(li);
        });
        wrap.appendChild(ul);
      }
      return wrap;
    }
    function onNodeClick(node) {
      if (window.flowcutPlanBridge && node && node.id) {
        window.flowcutPlanBridge.onNodeClicked(node.id);
      }
    }
    if (typeof QWebChannel !== 'undefined' && typeof qt !== 'undefined' && qt.webChannelTransport) {
      try {
        new QWebChannel(qt.webChannelTransport, function(ch) {
          window.flowcutPlanBridge = ch.objects.flowcutPlanBridge || null;
        });
      } catch (e) { window.flowcutPlanBridge = null; }
    } else {
      window.flowcutPlanBridge = null;
    }
  </script>
</body>
</html>
